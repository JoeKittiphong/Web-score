<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ระบบจัดการคะแนนหลายวิชา</title>
<style>
  body { font-family: sans-serif; max-width: 500px; margin: auto; padding: 10px; }
  h1 { text-align: center; }
  select, input, button { padding: 5px; margin: 3px 0; font-size: 1rem; }
  .player {
    border: 1px solid #ccc;
    border-radius: 8px;
    padding: 5px;
    margin-bottom: 8px;
    background: #f9f9f9;
  }
  .row-top {
    display: flex;
    align-items: center;
  }
  .name {
    width: 70%;
    font-size: 1.2rem;
    font-weight: bold;
    padding-left: 5px;
  }
  .score {
    width: 30%;
    font-size: 1.4rem;
    font-weight: bold;
    display: flex;
    justify-content: center;
    align-items: center;
  }
  .row-bottom {
    display: flex;
    margin-top: 5px;
  }
  .btn {
    padding: 8px;
    border: none;
    cursor: pointer;
    font-size: 1rem;
  }
  .btn-add { background: #4CAF50; color: white; width: 40%; }
  .btn-sub { background: #F44336; color: white; width: 40%; }
  .btn-del { background: #aaa; color: white; width: 20%; font-weight: bold; }
  .drag-over { background: #d0f0ff !important; }
</style>
</head>
<body>

<h1>ระบบจัดการเงินเจ้ามือ</h1>

<div>
  <label>เจ้ามือ: </label>
  <select id="subjectSelect" onchange="changeSubject()"></select>
  <button onclick="addSubject()">+ เพิ่มเจ้ามือ</button>
</div>

<div>
  <label>ตาละ: </label>
  <input type="number" id="pointValue" value="20">
</div>

<div>
  <input type="text" id="playerName" placeholder="ชื่อผู้เล่น">
  <button onclick="addPlayer()">เพิ่ม</button>
</div>

<div id="playerList"></div>

<script>
let data = JSON.parse(localStorage.getItem("multiSubjectData") || '{"subjects": {}, "current": ""}');
let subjectSelect = document.getElementById("subjectSelect");
let playerList = document.getElementById("playerList");
let pointValueInput = document.getElementById("pointValue");
let draggedIndex = null;

function saveData() {
  localStorage.setItem("multiSubjectData", JSON.stringify(data));
}

function addSubject() {
  let name = prompt("ชื่อเจ้ามือ:");
  if (name && !data.subjects[name]) {
    data.subjects[name] = [];
    data.current = name;
    saveData();
    renderSubjects();
    renderPlayers();
  }
}

function changeSubject() {
  data.current = subjectSelect.value;
  saveData();
  renderPlayers();
}

function renderSubjects() {
  subjectSelect.innerHTML = "";
  Object.keys(data.subjects).forEach(subj => {
    let opt = document.createElement("option");
    opt.value = subj;
    opt.textContent = subj;
    if (subj === data.current) opt.selected = true;
    subjectSelect.appendChild(opt);
  });
}

function renderPlayers() {
  playerList.innerHTML = "";
  if (!data.current) return;
  let players = data.subjects[data.current];
  players.forEach((p, index) => {
    let div = document.createElement("div");
    div.className = "player";
    div.draggable = true;

    // Drag Events
    div.addEventListener("dragstart", e => {
      draggedIndex = index;
    });
    div.addEventListener("dragover", e => {
      e.preventDefault();
      div.classList.add("drag-over");
    });
    div.addEventListener("dragleave", e => {
      div.classList.remove("drag-over");
    });
    div.addEventListener("drop", e => {
      e.preventDefault();
      div.classList.remove("drag-over");
      if (draggedIndex !== null && draggedIndex !== index) {
        let moved = players.splice(draggedIndex, 1)[0];
        players.splice(index, 0, moved);
        saveData();
        renderPlayers();
      }
    });

    // Touch Events (Mobile)
    let touchStartY = null;
    div.addEventListener("touchstart", e => {
      draggedIndex = index;
      touchStartY = e.touches[0].clientY;
    });
    div.addEventListener("touchmove", e => {
      e.preventDefault();
      let touchY = e.touches[0].clientY;
      let target = document.elementFromPoint(e.touches[0].clientX, touchY);
      let dropTarget = target?.closest(".player");
      if (dropTarget && dropTarget !== div) {
        let dropIndex = Array.from(playerList.children).indexOf(dropTarget);
        if (dropIndex !== -1 && dropIndex !== draggedIndex) {
          let moved = players.splice(draggedIndex, 1)[0];
          players.splice(dropIndex, 0, moved);
          draggedIndex = dropIndex;
          saveData();
          renderPlayers();
        }
      }
    });

    // Row 1
    let rowTop = document.createElement("div");
    rowTop.className = "row-top";
    let nameDiv = document.createElement("div");
    nameDiv.className = "name";
    nameDiv.textContent = p.name;
    let scoreDiv = document.createElement("div");
    scoreDiv.className = "score";
    scoreDiv.textContent = p.score;
    rowTop.appendChild(nameDiv);
    rowTop.appendChild(scoreDiv);

    // Row 2
    let rowBottom = document.createElement("div");
    rowBottom.className = "row-bottom";

    let btnAdd = document.createElement("button");
    btnAdd.className = "btn btn-add";
    btnAdd.textContent = "ได้";
    btnAdd.onclick = () => {
      p.score += Number(pointValueInput.value);
      saveData();
      renderPlayers();
    };

    let btnSub = document.createElement("button");
    btnSub.className = "btn btn-sub";
    btnSub.textContent = "เสีย";
    btnSub.onclick = () => {
      p.score -= Number(pointValueInput.value);
      saveData();
      renderPlayers();
    };

    let btnDel = document.createElement("button");
    btnDel.className = "btn btn-del";
    btnDel.textContent = "X";
    btnDel.onclick = () => {
      if (confirm(`ลบ ${p.name} ออกจากรายชื่อ?`)) {
        players.splice(index, 1);
        saveData();
        renderPlayers();
      }
    };

    rowBottom.appendChild(btnAdd);
    rowBottom.appendChild(btnSub);
    rowBottom.appendChild(btnDel);

    div.appendChild(rowTop);
    div.appendChild(rowBottom);
    playerList.appendChild(div);
  });
}

function addPlayer() {
  if (!data.current) {
    alert("กรุณาเพิ่มวิชาก่อน");
    return;
  }
  let name = document.getElementById("playerName").value.trim();
  if (name) {
    data.subjects[data.current].push({ name, score: 0 });
    document.getElementById("playerName").value = "";
    saveData();
    renderPlayers();
  }
}

// First load
if (!data.current) {
  addSubject();
} else {
  renderSubjects();
  renderPlayers();
}
</script>

</body>
</html>
