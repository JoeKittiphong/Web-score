<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ระบบจัดการเงินเจ้ามือ</title>
<style>
  body { font-family: sans-serif; max-width: 500px; margin: auto; padding: 10px; }
  h1 { text-align: center; }
  select, input, button { padding: 5px; margin: 3px 0; font-size: 1rem; }
  .player {
    border: 1px solid #ccc;
    border-radius: 8px;
    padding: 5px;
    margin-bottom: 8px;
    background: #f9f9f9;
  }
  .row-top {
    display: flex;
    align-items: center;
  }
  .name {
    width: 70%;
    font-size: 1.2rem;
    font-weight: bold;
    padding-left: 5px;
  }
  .score {
    width: 30%;
    font-size: 1.4rem;
    font-weight: bold;
    display: flex;
    justify-content: center;
    align-items: center;
  }
  .row-bottom {
    display: flex;
    margin-top: 5px;
  }
  .btn {
    padding: 8px;
    border: none;
    cursor: pointer;
    font-size: 1rem;
  }
  .btn-add { background: #4CAF50; color: white; width: 40%; }
  .btn-sub { background: #F44336; color: white; width: 40%; }
  .btn-del { background: #aaa; color: white; width: 20%; font-weight: bold; }
  .drag-over { background: #d0f0ff !important; }
  .multiplier-buttons button {
    margin: 2px;
    padding: 5px 10px;
    font-size: 0.9rem;
    border: 1px solid #999;
    background: #eee;
    cursor: pointer;
    border-radius: 4px;
  }
  .multiplier-buttons button.active {
    background: #4CAF50;
    color: white;
    font-weight: bold;
  }
  .multiplier-buttons button:hover {
    background: #ddd;
  }
  .current-value {
    margin-top: 5px;
    font-weight: bold;
    color: #333;
  }
</style>
</head>
<body>

<h1>ระบบจัดการเงินเจ้ามือ</h1>

<div>
  <label>เจ้ามือ: </label>
  <select id="subjectSelect" onchange="changeSubject()"></select>
  <button onclick="addSubject()">+ เพิ่มเจ้ามือ</button>
</div>

<div>
  <label>ตาละ: </label>
  <input type="number" id="pointValue" value="20" oninput="updateCurrentValue()">
  <div class="multiplier-buttons">
    <button onclick="toggleMultiplier(2)">×2</button>
    <button onclick="toggleMultiplier(3)">×3</button>
    <button onclick="toggleMultiplier(4)">×4</button>
    <button onclick="toggleMultiplier(5)">×5</button>
    <button onclick="toggleMultiplier(6)">×6</button>
    <button onclick="toggleMultiplier(8)">×8</button>
    <button onclick="toggleMultiplier(10)">×10</button>
    <button onclick="toggleMultiplier(12)">×12</button>
  </div>
  <div class="current-value">ค่าที่ใช้คิด: <span id="currentValue">20</span></div>
</div>

<div>
  <input type="text" id="playerName" placeholder="ชื่อผู้เล่น">
  <button onclick="addPlayer()">เพิ่ม</button>
</div>

<div id="playerList"></div>

<script>
let data = JSON.parse(localStorage.getItem("multiSubjectData") || '{"subjects": {}, "current": ""}');
let subjectSelect = document.getElementById("subjectSelect");
let playerList = document.getElementById("playerList");
let pointValueInput = document.getElementById("pointValue");
let currentValueSpan = document.getElementById("currentValue");
let draggedIndex = null;

let activeMultiplier = 1; // ค่า multiplier ปัจจุบัน

function saveData() {
  localStorage.setItem("multiSubjectData", JSON.stringify(data));
}

function addSubject() {
  let name = prompt("ชื่อเจ้ามือ:");
  if (name && !data.subjects[name]) {
    data.subjects[name] = [];
    data.current = name;
    saveData();
    renderSubjects();
    renderPlayers();
  }
}

function changeSubject() {
  data.current = subjectSelect.value;
  saveData();
  renderPlayers();
}

function renderSubjects() {
  subjectSelect.innerHTML = "";
  Object.keys(data.subjects).forEach(subj => {
    let opt = document.createElement("option");
    opt.value = subj;
    opt.textContent = subj;
    if (subj === data.current) opt.selected = true;
    subjectSelect.appendChild(opt);
  });
}

function renderPlayers() {
  playerList.innerHTML = "";
  if (!data.current) return;
  let players = data.subjects[data.current];
  players.forEach((p, index) => {
    let div = document.createElement("div");
    div.className = "player";
    div.draggable = true;

    // Drag Events
    div.addEventListener("dragstart", e => {
      draggedIndex = index;
    });
    div.addEventListener("dragover", e => {
      e.preventDefault();
      div.classList.add("drag-over");
    });
    div.addEventListener("dragleave", e => {
      div.classList.remove("drag-over");
    });
    div.addEventListener("drop", e => {
      e.preventDefault();
      div.classList.remove("drag-over");
      if (draggedIndex !== null && draggedIndex !== index) {
        let moved = players.splice(draggedIndex, 1)[0];
        players.splice(index, 0, moved);
        saveData();
        renderPlayers();
      }
    });

    // Row 1
    let rowTop = document.createElement("div");
    rowTop.className = "row-top";
    let nameDiv = document.createElement("div");
    nameDiv.className = "name";
    nameDiv.textContent = p.name;
    let scoreDiv = document.createElement("div");
    scoreDiv.className = "score";
    scoreDiv.textContent = p.score;
    rowTop.appendChild(nameDiv);
    rowTop.appendChild(scoreDiv);

    // Row 2
    let rowBottom = document.createElement("div");
    rowBottom.className = "row-bottom";

    let btnAdd = document.createElement("button");
    btnAdd.className = "btn btn-add";
    btnAdd.textContent = "ได้";
    btnAdd.onclick = () => {
      p.score += getCurrentValue();
      saveData();
      renderPlayers();
    };

    let btnSub = document.createElement("button");
    btnSub.className = "btn btn-sub";
    btnSub.textContent = "เสีย";
    btnSub.onclick = () => {
      p.score -= getCurrentValue();
      saveData();
      renderPlayers();
    };

    let btnDel = document.createElement("button");
    btnDel.className = "btn btn-del";
    btnDel.textContent = "X";
    btnDel.onclick = () => {
      if (confirm(`ลบ ${p.name} ออกจากรายชื่อ?`)) {
        players.splice(index, 1);
        saveData();
        renderPlayers();
      }
    };

    rowBottom.appendChild(btnAdd);
    rowBottom.appendChild(btnSub);
    rowBottom.appendChild(btnDel);

    div.appendChild(rowTop);
    div.appendChild(rowBottom);
    playerList.appendChild(div);
  });
}

function addPlayer() {
  if (!data.current) {
    alert("กรุณาเพิ่มเจ้ามือก่อน");
    return;
  }
  let name = document.getElementById("playerName").value.trim();
  if (name) {
    data.subjects[data.current].push({ name, score: 0 });
    document.getElementById("playerName").value = "";
    saveData();
    renderPlayers();
  }
}

function getCurrentValue() {
  return Number(pointValueInput.value) * activeMultiplier;
}

function updateCurrentValue() {
  currentValueSpan.textContent = getCurrentValue();
}

function toggleMultiplier(multiplier) {
  let buttons = document.querySelectorAll(".multiplier-buttons button");

  if (activeMultiplier === multiplier) {
    // ถ้ากดซ้ำ -> reset กลับ 1
    activeMultiplier = 1;
  } else {
    activeMultiplier = multiplier;
  }

  // update ปุ่ม active
  buttons.forEach(btn => {
    btn.classList.remove("active");
    if (btn.textContent === "×" + multiplier && activeMultiplier === multiplier) {
      btn.classList.add("active");
    }
  });

  updateCurrentValue();
}

// First load
if (!data.current) {
  addSubject();
} else {
  renderSubjects();
  renderPlayers();
}
updateCurrentValue();
</script>

</body>
</html>