<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>จัดการคะแนน</title>
<style>
    body {
        font-family: sans-serif;
        max-width: 500px;
        margin: auto;
        padding: 20px;
        background: #f4f4f4;
    }
    h2 { text-align: center; }
    .player {
        background: #fff;
        padding: 10px;
        margin: 5px 0;
        display: flex;
        align-items: center;
        justify-content: space-between;
        border-radius: 5px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        gap: 5px;
        touch-action: none; /* ป้องกัน Scroll ระหว่างลาก */
    }
    .player input[type="text"] {
        border: none;
        font-size: 1em;
        width: 120px;
        background: transparent;
    }
    .score {
        font-size: 1.2em;
        font-weight: bold;
        width: 50px;
        text-align: center;
    }
    button {
        padding: 5px 8px;
        cursor: pointer;
        border: none;
        border-radius: 4px;
    }
    .btn-add { background: #4caf50; color: white; }
    .btn-sub { background: #f44336; color: white; }
    .btn-del { background: gray; color: white; }
    #topControls {
        display: flex;
        align-items: center;
        gap: 5px;
        margin-bottom: 10px;
    }
    #addPlayerSection {
        display: flex;
        margin-bottom: 10px;
    }
    #addPlayerSection input {
        flex: 1;
        padding: 5px;
        margin-right: 5px;
    }
    .drag-over {
        border: 2px dashed #2196f3;
        background: #e3f2fd;
    }
</style>
</head>
<body>

<h2>ระบบจัดการคะแนน</h2>

<!-- ควบคุมคะแนนกลาง -->
<div id="topControls">
    <label>คะแนนกลาง:</label>
    <input type="number" id="globalChange" value="1" style="width:80px;">
</div>

<!-- เพิ่มผู้เล่น -->
<div id="addPlayerSection">
    <input type="text" id="playerName" placeholder="ชื่อผู้เล่น">
    <button onclick="addPlayer()">เพิ่ม</button>
</div>

<!-- รายชื่อผู้เล่น -->
<div id="players"></div>

<script>
let players = JSON.parse(localStorage.getItem("players")) || [];
let draggedIndex = null;
let touchStartIndex = null;

function saveData() {
    localStorage.setItem("players", JSON.stringify(players));
}

function renderPlayers() {
    const container = document.getElementById("players");
    container.innerHTML = "";
    players.forEach((player, index) => {
        const div = document.createElement("div");
        div.className = "player";
        div.draggable = true; // Desktop drag

        // Desktop Drag & Drop
        div.addEventListener("dragstart", () => { draggedIndex = index; });
        div.addEventListener("dragover", (e) => {
            e.preventDefault();
            div.classList.add("drag-over");
        });
        div.addEventListener("dragleave", () => {
            div.classList.remove("drag-over");
        });
        div.addEventListener("drop", () => {
            div.classList.remove("drag-over");
            if (draggedIndex !== null && draggedIndex !== index) {
                const draggedItem = players.splice(draggedIndex, 1)[0];
                players.splice(index, 0, draggedItem);
                saveData();
                renderPlayers();
            }
        });

        // Mobile Touch Drag
        div.addEventListener("touchstart", () => { touchStartIndex = index; });
        div.addEventListener("touchmove", (e) => {
            e.preventDefault();
            const touch = e.touches[0];
            const target = document.elementFromPoint(touch.clientX, touch.clientY);
            const over = target?.closest(".player");
            document.querySelectorAll(".player").forEach(p => p.classList.remove("drag-over"));
            if (over && over !== div) over.classList.add("drag-over");
        });
        div.addEventListener("touchend", (e) => {
            const touch = e.changedTouches[0];
            const target = document.elementFromPoint(touch.clientX, touch.clientY);
            const dropTarget = target?.closest(".player");
            document.querySelectorAll(".player").forEach(p => p.classList.remove("drag-over"));
            if (dropTarget) {
                const dropIndex = Array.from(container.children).indexOf(dropTarget);
                if (touchStartIndex !== null && dropIndex !== touchStartIndex) {
                    const draggedItem = players.splice(touchStartIndex, 1)[0];
                    players.splice(dropIndex, 0, draggedItem);
                    saveData();
                    renderPlayers();
                }
            }
            touchStartIndex = null;
        });

        // HTML ภายในแถว
        div.innerHTML = `
            <input type="text" value="${player.name}" onchange="editName(${index}, this.value)">
            <div class="score">${player.score}</div>
            <button class="btn-add" onclick="changeScore(${index}, true)">ได้</button>
            <button class="btn-sub" onclick="changeScore(${index}, false)">เสีย</button>
            <button class="btn-del" onclick="removePlayer(${index})">ลบ</button>
        `;
        container.appendChild(div);
    });
}

function addPlayer() {
    const name = document.getElementById("playerName").value.trim();
    if (name) {
        players.push({ name: name, score: 0 });
        document.getElementById("playerName").value = "";
        saveData();
        renderPlayers();
    }
}

function removePlayer(index) {
    if (confirm(`คุณต้องการลบ "${players[index].name}" ออกจากรายการหรือไม่?`)) {
        players.splice(index, 1);
        saveData();
        renderPlayers();
    }
}

function editName(index, newName) {
    players[index].name = newName;
    saveData();
}

function changeScore(index, isAdd) {
    let amount = parseInt(document.getElementById("globalChange").value);
    if (isNaN(amount)) amount = 1;
    if (isAdd) {
        players[index].score += amount;
    } else {
        players[index].score -= amount;
    }
    saveData();
    renderPlayers();
}

renderPlayers();
</script>

</body>
</html>
